<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VSE Stock Trainer</title>
<style>
  :root{--bg:#f5f7fb;--card:#fff;--text:#111;--muted:#475569;--primary:#0f1724}
  [data-theme="dark"]{--bg:#071126;--card:#071126;--text:#e6eef8;--muted:#9fb0c8;--primary:#60a5fa}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text)}
  header{background:var(--primary);color:#fff;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:18px}
  .wrap{max-width:1200px;margin:18px auto;padding:16px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(10,20,40,0.06);margin-bottom:12px}
  input,select,button{padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:14px}
  button{cursor:pointer;background:var(--primary);color:#fff;border:none}
  .row{display:flex;gap:16px;align-items:flex-start}
  .left{flex:1}.right{width:420px}
  .small{font-size:13px;color:var(--muted)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  #chart{height:460px}
  .search-suggestions{max-height:220px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px;background:var(--card);margin-top:6px}
  .suggest-item{padding:8px;border-bottom:1px solid #f1f5f9;cursor:pointer}
  .suggest-item:hover{background:#f8fafc}
  footer{padding:14px;text-align:center;color:var(--muted)}
  .muted{color:var(--muted)}
  .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:var(--text);padding:8px;border-radius:8px;cursor:pointer}
</style>
</head>
<body data-theme="light">

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <h1>VSE Stock Trainer</h1>
    <div style="background:#fff1; padding:6px 10px; border-radius:8px; color:#fff" class="small">Demo balance ₹100,000</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="theme-toggle" class="btn-ghost">Toggle theme</button>
  </div>
</header>

<div class="wrap">
  <!-- Login -->
  <div id="login-card" class="card">
    <h2>Login / Sign up</h2>
    <div class="small">New accounts get <b>₹100,000</b> virtual balance. Admin: <b>admin6@vse.com</b></div>
    <div style="display:flex;gap:8px;margin-top:12px;max-width:820px">
      <input id="email" placeholder="Email" style="flex:1" />
      <input id="password" type="password" placeholder="Password" style="width:220px" />
      <button id="btn-login">Login / Create</button>
    </div>
    <div id="login-msg" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 id="welcome">Dashboard</h2>
        <div id="user-email" class="small"></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="small">Balance: <b id="balance">-</b></div>
        <button id="btn-logout" class="btn-ghost">Logout</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="left">
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="search" placeholder="Search symbol or company (e.g., RELIANCE, TCS)" style="flex:1" />
            <select id="exchange" title="Prefer exchange">
              <option value="AUTO">Auto</option>
              <option value="NSE">NSE</option>
              <option value="BSE">BSE</option>
            </select>
            <button id="btn-search">Search</button>
          </div>
          <div id="suggestions" class="search-suggestions hidden"></div>
        </div>

        <div id="chart-card" class="card hidden" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 id="stock-title">Select a company</h3>
              <div id="stock-sub" class="small muted"></div>
            </div>
            <div style="text-align:right">
              <div class="small">Live price</div>
              <div id="live" style="font-weight:700">-</div>
            </div>
          </div>

          <div id="chart" style="margin-top:12px"></div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
            <input id="qty" type="number" min="1" value="1" style="width:110px" />
            <button id="buy">Buy</button>
            <button id="sell" style="background:#ef4444">Sell</button>
            <button id="add-watch" class="btn-ghost">Add to Watchlist</button>
            <div style="margin-left:auto" id="company-info" class="small muted"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Portfolio</h3>
          <div class="small">Holdings & current value</div>
          <table id="portfolio-table">
            <thead><tr><th>Symbol</th><th>Qty</th><th>Avg Price</th><th>Price</th><th>Value</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h4>Quick info</h4>
          <div class="small">Initial virtual capital: <b>₹100,000</b></div>
          <div class="small" style="margin-top:8px">Twelve Data status: <span id="td-status">checking...</span></div>
          <hr/>
          <h4>Recent trades</h4>
          <ul id="trades" style="max-height:220px;overflow:auto;padding-left:18px"></ul>
        </div>

        <div id="admin-card" class="card hidden" style="margin-top:12px">
          <h4>Admin Panel</h4>
          <div class="small">You are logged in as admin. <button id="open-admin" class="btn-ghost">Open Admin</button></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Watchlist</h4>
          <div id="watchlist" class="small muted" style="margin-top:8px">No items</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin page -->
  <div id="admin-page" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Admin — Leaderboard</h2>
      <div><span class="small">Admin: <b id="admin-email"></b></span><button id="admin-back" class="btn-ghost">Back</button></div>
    </div>
    <table id="admin-table" style="margin-top:12px">
      <thead><tr><th>#</th><th>Email</th><th>Balance</th><th>Holdings</th><th>Total</th><th>Profit</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<footer>VSE Stock Trainer — Demo only. Data by Twelve Data. Do not use for real trading.</footer>

<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script type="module">
/* ============ CONFIG (you provided) ============ */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyB29xewVwNPd3TNBOvWZuIZvvKG1UKxy_w",
  authDomain: "stocktrainer-d9e64.firebaseapp.com",
  projectId: "stocktrainer-d9e64",
  storageBucket: "stocktrainer-d9e64.firebasestorage.app",
  messagingSenderId: "699145381471",
  appId: "1:699145381471:web:bc1736154ff0e1877c9dea"
};
const TWELVE_API = "c933f15065e54a7b9d8908b084d72de1";
const ADMIN_EMAIL = "admin6@vse.com";
const ADMIN_PASSWORD = "adminvse2k25";

/* ============ Firebase init ============ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);

/* ============ UI ============ */
const loginCard = document.getElementById('login-card');
const dashboard = document.getElementById('dashboard');
const adminPage = document.getElementById('admin-page');

const emailEl = document.getElementById('email');
const pwdEl = document.getElementById('password');
const btnLogin = document.getElementById('btn-login');
const loginMsg = document.getElementById('login-msg');

const userEmail = document.getElementById('user-email');
const balanceEl = document.getElementById('balance');
const portfolioTable = document.querySelector('#portfolio-table tbody');
const tradesEl = document.getElementById('trades');

const searchEl = document.getElementById('search');
const exchangeEl = document.getElementById('exchange');
const btnSearch = document.getElementById('btn-search');
const suggestions = document.getElementById('suggestions');

const chartCard = document.getElementById('chart-card');
const stockTitle = document.getElementById('stock-title');
const stockSub = document.getElementById('stock-sub');
const liveEl = document.getElementById('live');
const selectedSymbolEl = document.getElementById('selected-symbol');
const qtyEl = document.getElementById('qty');
const buyBtn = document.getElementById('buy');
const sellBtn = document.getElementById('sell');
const addWatchBtn = document.getElementById('add-watch');
const companyInfo = document.getElementById('company-info');
const tdStatus = document.getElementById('td-status');

const watchlistEl = document.getElementById('watchlist');
const adminCard = document.getElementById('admin-card');
const openAdminBtn = document.getElementById('open-admin');
const adminTableBody = document.querySelector('#admin-table tbody');
const adminEmailEl = document.getElementById('admin-email');
const adminBackBtn = document.getElementById('admin-back');

const themeToggle = document.getElementById('theme-toggle');

let currentUser = null;
let currentUserDoc = null;
let chart = null;
let candleSeries = null;
let selectedSymbol = null;
let lastBar = null;
let priceInterval = null;

/* ============ UTIL ============ */
function show(view){
  loginCard.classList.add('hidden');
  dashboard.classList.add('hidden');
  adminPage.classList.add('hidden');
  view.classList.remove('hidden');
}
function money(x){ return '₹' + Number(x).toLocaleString('en-IN', { maximumFractionDigits: 2 }); }
async function ensureUserDoc(uid, email){
  const ref = doc(db,'users',uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    const initial = { email, balance: 100000, portfolio: {}, trades: [], pending: [], watchlist: [], createdAt: Date.now() };
    await setDoc(ref, initial);
    return initial;
  }
  return snap.data();
}

/* ============ Twelve Data helpers ============ */
async function tdSearch(q){
  const url = `https://api.twelvedata.com/search?symbol=${encodeURIComponent(q)}&apikey=${TWELVE_API}`;
  const res = await fetch(url); const j = await res.json();
  return j.data || [];
}
async function tdPrice(sym){
  const url = `https://api.twelvedata.com/price?symbol=${encodeURIComponent(sym)}&apikey=${TWELVE_API}`;
  const r = await fetch(url); const j = await r.json();
  return j.price ? Number(j.price) : null;
}
async function tdCandles(sym, interval='1min', output=500){
  const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(sym)}&interval=${interval}&outputsize=${output}&format=JSON&apikey=${TWELVE_API}`;
  const r = await fetch(url); return await r.json();
}

/* normalise: accepts forms like 'RELIANCE', 'RELIANCE.NS', 'NSE:RELIANCE' -> returns 'NSE:RELIANCE' or 'BSE:XXX' */
function toTDSymbol(input, prefer){
  if(!input) return input;
  if(input.includes(':')) return input;
  input = input.trim();
  if(input.endsWith('.NS')) return 'NSE:' + input.replace('.NS','');
  if(input.endsWith('.BO')) return 'BSE:' + input.replace('.BO','');
  if(prefer === 'NSE') return 'NSE:' + input;
  if(prefer === 'BSE') return 'BSE:' + input;
  return 'NSE:' + input;
}

/* ============ Charting ============ */
function createChartIfNeeded(){
  if(chart) return;
  chart = LightweightCharts.createChart(document.getElementById('chart'), {
    width: document.getElementById('chart').clientWidth,
    height: 460,
    layout: { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg'), textColor: getComputedStyle(document.body).getPropertyValue('--text') },
    grid: { vertLines: { color: '#f1f5f9' }, horzLines: { color: '#f1f5f9' } },
    timeScale: { timeVisible: true, secondsVisible: false }
  });
  candleSeries = chart.addCandlestickSeries();
  window.addEventListener('resize', ()=> chart.applyOptions({ width: document.getElementById('chart').clientWidth }));
}

async function openChart(symRaw){
  try{
    const pref = exchange.value || 'AUTO';
    const sym = toTDSymbol(symRaw, pref==='AUTO'? 'NSE' : pref);
    selectedSymbol = sym;
    selectedSymbolEl && (selectedSymbolEl.textContent = sym);
    stockTitle.textContent = sym;
    stockSub.textContent = 'Loading...';
    companyInfo.textContent = '';
    createChartIfNeeded();

    // fetch search profile (best-effort)
    try{
      const sres = await tdSearch(symRaw);
      if(sres && sres.length){
        const found = sres.find(x=>x.symbol===sym) || sres[0];
        stockTitle.textContent = (found.instrument_name || found.symbol) + ' (' + (found.exchange || '') + ')';
        companyInfo.textContent = (found.exchange || '') + (found.country? (' • ' + found.country):'');
      }
    }catch(e){}

    // candles
    const raw = await tdCandles(sym,'1min',500);
    if(!raw || raw.status === 'error' || !raw.values || raw.values.length===0){
      stockSub.textContent = 'No intraday candles available for ' + sym;
      tdStatus.textContent = 'No data';
      candleSeries.setData([]);
      liveEl.textContent = '-';
      return;
    }
    // convert ascending
    const vals = raw.values.slice().reverse();
    const bars = vals.map(v => ({ time: Math.floor(new Date(v.datetime).getTime()/1000), open: Number(v.open), high: Number(v.high), low: Number(v.low), close: Number(v.close) }));
    candleSeries.setData(bars);
    lastBar = bars[bars.length-1];
    stockSub.textContent = 'Showing latest candles';
    tdStatus.textContent = 'OK';

    // start live price loop
    if(priceInterval) clearInterval(priceInterval);
    await updateLive(); // immediate
    priceInterval = setInterval(updateLive, 1000);

    // show panel
    chartCard.classList.remove('hidden');
  }catch(err){
    console.error(err);
    alert('Chart error: ' + (err.message||err));
  }
}

async function updateLive(){
  if(!selectedSymbol) return;
  try{
    const p = await tdPrice(selectedSymbol);
    if(!p){ liveEl.textContent = '-'; return; }
    liveEl.textContent = money(p);
    // minute bucket
    const now = new Date();
    const minuteStart = Math.floor(now.getTime() / 1000 / 60) * 60;
    if(!lastBar || minuteStart > lastBar.time){
      const prevClose = lastBar ? lastBar.close : p;
      const newBar = { time: minuteStart, open: prevClose, high: p, low: p, close: p };
      candleSeries.update(newBar);
      lastBar = newBar;
    } else {
      lastBar.high = Math.max(lastBar.high, p);
      lastBar.low = Math.min(lastBar.low, p);
      lastBar.close = p;
      candleSeries.update({ time: lastBar.time, open: lastBar.open, high: lastBar.high, low: lastBar.low, close: lastBar.close });
    }
    await refreshPricesOnly();
  }catch(e){ console.warn('live update failed', e); }
}

/* ============ Auth flows ============ */
btnLogin.addEventListener('click', async ()=>{
  const email = emailEl.value.trim();
  const pwd = pwdEl.value.trim();
  if(!email||!pwd){ loginMsg.textContent = 'Enter email & password'; return; }
  loginMsg.textContent = 'Working...';

  try{
    await signInWithEmailAndPassword(auth, email, pwd).then(async cred=>{
      currentUser = cred.user;
      currentUserDoc = await ensureUserDoc(currentUser.uid, currentUser.email);
      loginMsg.textContent = '';
      await refreshUI();
      show(dashboard);
    });
  }catch(err){
    if(err.code === 'auth/user-not-found'){
      // block creating admin via signup unless admin credentials used
      if(email === ADMIN_EMAIL && pwd !== ADMIN_PASSWORD){ loginMsg.textContent = 'Admin exists — use correct password'; return; }
      try{
        if(email === ADMIN_EMAIL && pwd === ADMIN_PASSWORD){
          await createUserWithEmailAndPassword(auth, email, pwd).then(async cred=>{
            currentUser = cred.user;
            await setDoc(doc(db,'users',currentUser.uid), { email: currentUser.email, balance:100000, portfolio:{}, trades:[], createdAt:Date.now() });
            currentUserDoc = await ensureUserDoc(currentUser.uid, currentUser.email);
            loginMsg.textContent = '';
            await refreshUI();
            show(dashboard);
          });
        } else {
          await createUserWithEmailAndPassword(auth, email, pwd).then(async cred=>{
            currentUser = cred.user;
            currentUserDoc = await ensureUserDoc(currentUser.uid, currentUser.email);
            loginMsg.textContent = '';
            await refreshUI();
            show(dashboard);
          });
        }
      }catch(e){ loginMsg.textContent = 'Signup failed: ' + e.message; }
    } else {
      loginMsg.textContent = 'Auth error: ' + err.message;
    }
  }
});

document.getElementById('btn-logout')?.addEventListener('click', async ()=>{
  await signOut(auth); currentUser = null; currentUserDoc = null; show(loginCard);
});

onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    currentUserDoc = await ensureUserDoc(user.uid, user.email);
    await refreshUI();
    show(dashboard);
  } else {
    currentUser = null; currentUserDoc = null; show(loginCard);
  }
});

/* ============ UI refresh ============ */
async function refreshUI(){
  if(!currentUser) return;
  const ref = doc(db,'users',currentUser.uid);
  const snap = await getDoc(ref); if(!snap.exists()) return;
  currentUserDoc = snap.data();
  userEmail.textContent = currentUser.email;
  balanceEl.textContent = money(currentUserDoc.balance || 0);

  // portfolio
  const port = currentUserDoc.portfolio || {};
  portfolioTable.innerHTML = '';
  const symbols = Object.keys(port);
  if(symbols.length === 0){
    portfolioTable.innerHTML = '<tr><td colspan="6" class="small">No holdings yet</td></tr>';
  } else {
    const prices = await Promise.all(symbols.map(s=>tdPrice(s).catch(()=>null)));
    symbols.forEach((s,idx)=>{
      const h = port[s];
      const curr = prices[idx] || 0;
      const val = (h.quantity||0) * curr;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="cursor:pointer;color:#0b61ff">${s}</td><td>${h.quantity}</td><td>${money(h.avgPrice||0)}</td><td>${curr?money(curr):'-'}</td><td>${curr?money(val):'-'}</td><td><button data-sym="${s}" class="sell-btn btn-ghost">Sell</button></td>`;
      tr.querySelector('td').onclick = ()=> openChart(s);
      portfolioTable.appendChild(tr);
    });
    document.querySelectorAll('.sell-btn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const s = b.getAttribute('data-sym');
        const q = prompt('Quantity to sell','1');
        if(!q) return;
        await sellStock(s, Number(q));
      });
    });
  }

  // trades
  tradesEl.innerHTML = '';
  (currentUserDoc.trades || []).slice().reverse().slice(0,50).forEach(t=>{
    const li = document.createElement('li');
    li.className = 'small';
    li.textContent = `[${new Date(t.time).toLocaleString()}] ${t.type.toUpperCase()} ${t.symbol} x ${t.qty} @ ${money(t.price)}`;
    tradesEl.appendChild(li);
  });

  // watchlist
  renderWatchlist();

  // admin link
  if(currentUser.email === ADMIN_EMAIL) adminCard.classList.remove('hidden'); else adminCard.classList.add('hidden');
}

/* update prices only for portfolio table */
async function refreshPricesOnly(){
  if(!currentUserDoc) return;
  const port = currentUserDoc.portfolio || {};
  const rows = portfolioTable.querySelectorAll('tr');
  if(rows.length === 0) return;
  const symbols = Object.keys(port);
  const prices = await Promise.all(symbols.map(s=>tdPrice(s).catch(()=>null)));
  rows.forEach((r,idx)=>{
    const pr = prices[idx] || 0;
    if(pr){
      r.children[3].textContent = money(pr);
      const qty = Number(r.children[1].textContent) || 0;
      r.children[4].textContent = money(qty * pr);
    }
  });
}

/* ============ Trading (buy/sell) ============ */
async function buyStock(symbol, qty){
  if(!currentUser) return alert('Login first');
  qty = Number(qty);
  if(!qty || qty<=0) return alert('Invalid qty');
  const price = await tdPrice(symbol);
  if(!price) return alert('Price not available');
  const ref = doc(db,'users',currentUser.uid);
  const snap = await getDoc(ref); const user = snap.data();
  const cost = price * qty;
  if(user.balance < cost) return alert('Insufficient balance');
  const portfolio = user.portfolio || {};
  if(!portfolio[symbol]) portfolio[symbol] = { quantity: qty, avgPrice: price };
  else {
    const prev = portfolio[symbol];
    const newQty = prev.quantity + qty;
    const newAvg = ((prev.avgPrice * prev.quantity) + (price * qty)) / newQty;
    portfolio[symbol] = { quantity: newQty, avgPrice: newAvg };
  }
  const trades = user.trades || [];
  trades.push({ type:'buy', symbol, qty, price, time: Date.now() });
  const newBalance = user.balance - cost;
  await updateDoc(ref, { balance: newBalance, portfolio, trades });
  await refreshUI();
  alert(`Bought ${qty} ${symbol} @ ${money(price)}`);
}

async function sellStock(symbol, qty){
  if(!currentUser) return alert('Login first');
  qty = Number(qty);
  if(!qty || qty<=0) return alert('Invalid qty');
  const ref = doc(db,'users',currentUser.uid);
  const snap = await getDoc(ref); const user = snap.data();
  const portfolio = user.portfolio || {};
  const holding = portfolio[symbol];
  if(!holding || holding.quantity < qty) return alert('Not enough shares');
  const price = await tdPrice(symbol);
  const proceeds = price * qty;
  const newQty = holding.quantity - qty;
  if(newQty <= 0) delete portfolio[symbol]; else portfolio[symbol].quantity = newQty;
  const trades = user.trades || [];
  trades.push({ type:'sell', symbol, qty, price, time: Date.now() });
  const newBalance = (user.balance || 0) + proceeds;
  await updateDoc(ref, { balance: newBalance, portfolio, trades });
  await refreshUI();
  alert(`Sold ${qty} ${symbol} @ ${money(price)}`);
}

/* ============ Search & suggestions ============ */
let suggestTimer = null;
search.addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  if(!q){ suggestions.classList.add('hidden'); return; }
  if(suggestTimer) clearTimeout(suggestTimer);
  suggestTimer = setTimeout(async ()=>{
    try{
      const results = await tdSearch(q);
      suggestions.innerHTML = '';
      if(!results || results.length===0){ suggestions.innerHTML = '<div class="small">No results</div>'; suggestions.classList.remove('hidden'); return; }
      results.slice(0,12).forEach(item=>{
        const d = document.createElement('div'); d.className = 'suggest-item';
        d.textContent = `${item.symbol} — ${item.instrument_name || ''} ${item.exchange? '• '+item.exchange:''}`;
        d.onclick = ()=> selectSuggestion(item);
        suggestions.appendChild(d);
      });
      suggestions.classList.remove('hidden');
    }catch(err){
      suggestions.innerHTML = '<div class="small">Search failed</div>'; suggestions.classList.remove('hidden');
    }
  }, 250);
});

function selectSuggestion(item){
  suggestions.classList.add('hidden');
  const sym = item.symbol;
  // use the exact symbol from TD (it already includes exchange like NSE:RELIANCE)
  openChart(sym);
}

btnSearch.addEventListener('click', async ()=>{
  const q = search.value.trim();
  if(!q) return alert('Type symbol or name');
  const items = await tdSearch(q);
  if(items && items.length>0){ selectSuggestion(items[0]); return; }
  // fallback: assume NSE
  openChart(toTDSymbol(q));
});

/* ============ Watchlist ============ */
async function renderWatchlist(){
  if(!currentUserDoc) { watchlistEl.textContent = 'No items'; return; }
  const list = currentUserDoc.watchlist || [];
  if(list.length === 0){ watchlistEl.textContent = 'No items'; return; }
  watchlistEl.innerHTML = '';
  await Promise.all(list.map(async (s)=>{
    const p = await tdPrice(s).catch(()=>null);
    const div = document.createElement('div');
    div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.padding = '6px 0';
    const left = document.createElement('div'); left.style.cursor='pointer'; left.style.color='#0b61ff'; left.textContent = s; left.onclick = ()=> openChart(s);
    const right = document.createElement('div'); right.textContent = p? money(p) : '-';
    div.appendChild(left); div.appendChild(right);
    watchlistEl.appendChild(div);
  }));
}

addWatchBtn.addEventListener('click', async ()=>{
  if(!currentUser) return alert('Login required');
  if(!selectedSymbol) return alert('Select a symbol first');
  const ref = doc(db,'users',currentUser.uid); const snap = await getDoc(ref); const user = snap.data();
  const watch = user.watchlist || [];
  if(!watch.includes(selectedSymbol)) watch.push(selectedSymbol);
  await updateDoc(ref, { watchlist: watch });
  await refreshUI();
  alert('Added to watchlist');
});

/* ============ Admin ============ */
openAdminBtn.addEventListener('click', async ()=>{
  if(!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Admin only');
  adminEmailEl.textContent = currentUser.email;
  show(adminPage);
  adminTableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
  try{
    const snaps = await getDocs(collection(db,'users'));
    const users = [];
    const symbolsSet = new Set();
    snaps.forEach(snap => { const d = snap.data(); users.push(d); Object.keys(d.portfolio||{}).forEach(sym=>symbolsSet.add(sym)); });
    const allSymbols = Array.from(symbolsSet);
    const priceMap = {};
    await Promise.all(allSymbols.map(async s => priceMap[s] = await tdPrice(s).catch(()=>0)));
    const rows = users.map(u=>{
      let holdings = 0;
      Object.entries(u.portfolio || {}).forEach(([sym,h]) => { holdings += (h.quantity||0) * (priceMap[sym] || 0); });
      const total = (u.balance||0) + holdings;
      const profit = total - 100000;
      return { email: u.email||'(no email)', balance: u.balance||0, holdings, total, profit };
    });
    rows.sort((a,b)=> b.profit - a.profit);
    adminTableBody.innerHTML = '';
    rows.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.email}</td><td>${money(r.balance)}</td><td>${money(r.holdings)}</td><td>${money(r.total)}</td><td>${money(r.profit)}</td>`;
      if(i<3) tr.style.background = i===0 ? 'linear-gradient(90deg,#fef3c7,#fef7c3)' : 'linear-gradient(90deg,#eef2ff,#eefbff)';
      adminTableBody.appendChild(tr);
    });
  }catch(e){ adminTableBody.innerHTML = '<tr><td colspan="6">Failed to load</td></tr>'; }
});
adminBackBtn.addEventListener('click', ()=> show(dashboard));

/* ============ Initial checks ============ */
(async function initCheck(){
  try{
    const r = await fetch(`https://api.twelvedata.com/price?symbol=NSE:RELIANCE&apikey=${TWELVE_API}`);
    const j = await r.json();
    if(j.price) tdStatus.textContent = 'OK';
    else tdStatus.textContent = 'Reachable but might have limited symbols';
  }catch(e){ tdStatus.textContent = 'Twelve Data unreachable'; }
})();

/* ============ Buttons: buy/sell from chart ============ */
buyBtn.addEventListener('click', async ()=> {
  if(!selectedSymbol) return alert('Select a symbol first');
  await buyStock(selectedSymbol, Number(qtyEl.value || 1));
});
sellBtn.addEventListener('click', async ()=> {
  if(!selectedSymbol) return alert('Select a symbol first');
  await sellStock(selectedSymbol, Number(qtyEl.value || 1));
});

/* ============ Theme toggle ============ */
themeToggle.addEventListener('click', ()=>{
  const root = document.body;
  const cur = root.getAttribute('data-theme') || 'light';
  root.setAttribute('data-theme', cur === 'light' ? 'dark' : 'light');
  if(chart) chart.applyOptions({ layout: { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg'), textColor: getComputedStyle(document.body).getPropertyValue('--text') }});
});

/* ============ Helper expose for input fallback ============ */
function toTDSymbol(x){ return toTDSymbol(x); }

/* Show login initially */
show(loginCard);
</script>
</body>
</html>
